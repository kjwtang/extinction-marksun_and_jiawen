---
title: "Extinctions Unit"
author: "Jiawen Tang, Mark Sun"
maketitle: true
output: github_document
---

## The Sixth Great Extinctions

*Are we experiencing the sixth great extinction?*

What is the current pace of extinction? Is it accelerating? How does it compare to background extinction rates?

## Background

-   [Section Intro Video](https://youtu.be/QsH6ytm89GI)
-   [Ceballos et al (2015)](http://doi.org/10.1126/sciadv.1400253)

Our focal task will be to reproduce the result from Ceballos and colleagues showing the recent increase in extinction rates relative to the background rate:

![](https://espm-157.carlboettiger.info/img/extinctions.jpg)

Before everything starts, we will set up the functions that we need to use to run the code"

```{r include=FALSE}
library("tidyverse")
library("httr")
library("jsonlite")
library("glue")
knitr::opts_chunk$set(comment=NA)
```

We will download the data taht we need from ICUN redlist so we can start do anlysis from it. Since the orginal website is slow as multiple request starts at the same time, we will extract the data from the pre-download zip from our github.

```{r, message=FALSE, warning=FALSE, include=FALSE}
download.file("https://github.com/espm-157/extinction-template/releases/download/data2.0/extinction-data.zip", "extinction-data.zip")
unzip("extinction-data.zip")
```

To keep things simple, we will create a local version of rds so we do not need to download it again and again. This rds will be our data to look at.

```{r}
 if(!file.exists("all_species.rds")) {
   all_species <- map(all_pages, GET)
   map(all_species,stop_for_status)
   write_rds(all_species, "all_species.rds")
 }
```

So setups are finished and we can load the data! From here we will start doing data anylsis and to extract the information to answer our question, if the sixth extinction happens and how does it compares to the backgroup extinction rate.

```{r}
all_species<- read_rds("all_species.rds")
all_resp <- map(all_species, content, encoding = "UTF-8")
```

So now we find out there are so many information in the dataset, we will find the things that are useful. We want to know the scientific name of the species, their category and the class that they are belongs to. After we get these information, merge them into a list that we call "all species". Since we want to focus on the extinction species, we will filter the category by "EX", which in IUCN is stands for extinction. In this case, we will have the whole list of species that are extinct.

```{r}
sci_name <- map(all_resp, \(page) map_chr(page$result,"scientific_name")) |>
  list_c()
category <-
  map(all_resp,\(page) map_chr(page$result,"category")) |>
  list_c()
class <-
  map(all_resp,\(page) map_chr(page$result,"class_name")) |>
  list_c()
all_species <- tibble(sci_name, category,class)

extinct_species <- all_species |> filter(category == "EX")
extinct_species
```

```{r}
ex_sci_name <-extinct_species$sci_name
```

Since its still a lot of data, we want to storage it to local to save our process as well. rds will be our working format and we do the same things as before.

```{r}

if(!file.exists("ex_narrative.rds")) {
  ex_narrative <- map(all_pages, GET)
  write_rds(ex_narrative, "ex_narrative.rds")
}

```

Read the rds file and we will start finding the extinction rate.

```{r}
ex_narrative <-read_rds("ex_narrative.rds")
```

So we want to use map function to extract the information from the rds file to the list of words that can have information about the extinction data. These information will be in plain text that is not in a consistant format that we can find the number directly.

```{r}
narrative_contents <- map(ex_narrative,content)
narrative_population <- map(narrative_contents,
                            \(content) map_chr(content$result[1],"population",.default = ""))
narrative_rationale <- map(narrative_contents,\(content) content$result[[1]]$rationale)

```

So how are we going to get dates from plain text? Regular expressions. We start simple and just grab any 4-digit numbers, we will just trust it as year (which there are two errors and we ignore it with the huge data set we have). Now we will find out the extinction time and species catagory. We will group by class, arrange by century, and limit it for the five big vertebrates.

```{r}
last_seen <-narrative_population |>
  map_chr(str_extract,"\\d{4}") |>
  as.integer()
extintion_dates <- tibble(sci_name = ex_sci_name,last_seen) |> distinct()
combined <- all_species |> left_join(extintion_dates)
total_sp <- combined |> 
  filter(class %in% c('MAMMALIA', 'AVES','AMPHIBIA','REPTILIA', 'ACTINOPTERYGII')) |>
  count(class, name = "total")
final_tbl <- combined |> 
  filter(category == "EX") |>
  filter(class %in% c('MAMMALIA', 'AVES','AMPHIBIA','REPTILIA', 'ACTINOPTERYGII')) |>
  mutate(last_seen = replace_na(last_seen, 2023),
         century = str_extract(last_seen, "\\d{2}")) |>
  count(century, class) |>
  left_join(total_sp) |>
  mutate(extinct_perc = (n/total) *10000)|> # extinctions per million-species-years
  mutate(century = as.numeric(century),
         century = ifelse(century < 21, century + 1, 21))
final_tbl
```

```{r}
cum_data <- final_tbl %>%
  group_by(class) %>%
  arrange(century) %>%
  mutate(cum_extinction = cumsum(n) / total * 10000)

# Remove grouping to return to the original state
cum_data <- ungroup(cum_data)
```

```{r}
background_slope <- 2

ggplot(cum_data, aes(x = century, y = cum_extinction, color = class)) +
  geom_line() +
  geom_abline(aes(intercept = -27, slope = background_slope),
              linetype = "dashed", color = "red") +
  annotate("text", x = 18, y = 0.1, label = "Background Extinction Rate", color = "red") +
  labs(title = "Cumulative Extinction Over Centuries",
       x = "Century",
       y = "Cumulative Extinction per million-species-years") +
  scale_x_continuous(breaks = seq(15, 21, by = 1)) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(color = "black"))
```

## Additional references:

-   <http://www.hhmi.org/biointeractive/biodiversity-age-humans> (Video)
-   [Barnosky et al. (2011)](http://doi.org/10.1038/nature09678)
-   [Pimm et al (2014)](http://doi.org/10.1126/science.1246752)
-   [Sandom et al (2014)](http://dx.doi.org/10.1098/rspb.2013.3254)
