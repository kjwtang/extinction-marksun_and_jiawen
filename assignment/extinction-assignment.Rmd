---
title: "Extinctions Unit"
author: "Jiawen Tang, Mark Sun"
maketitle: true
output: github_document
---

```{r include=FALSE}
library("tidyverse")
library("httr")
library("jsonlite")
library("glue")
#library("printr")
knitr::opts_chunk$set(comment=NA)
```

```{r}
base <- "https://apiv3.iucnredlist.org/api/v3"
endpoint <- "speciescount"
token <- "9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee"
req <- GET(glue("{base}/{endpoint}?token={token}"))
x = content(req)
x$speciescount
```

```{r}
species_endpoint <-"species"
page <- paste0("page/", 0:15)
page1 <- "page/1"
all_pages <- glue("{base}/{species_endpoint}/{page}?token={token}")
```

```{r}
if(!file.exists("all_species.rds")) {
  all_species <- map(all_pages, GET)
  map(all_species,stop_for_status)
  write_rds(all_species, "all_species.rds")
}
```

```{r}
all_species<- read_rds("all_species.rds")
```


```{r}
#codes <- map_int(all_species, status_code)
#stopifnot(all(codes < 400))
all_resp <- map(all_species, content, encoding = "UTF-8")
```

```{r}
sci_name <- map(all_resp, \(page) map_chr(page$result,"scientific_name")) |>
  list_c()
category <-
  map(all_resp,\(page) map_chr(page$result,"category")) |>
  list_c()
all_species <- tibble(sci_name, category)

extinct_species <- all_species |> filter(category == "EX")
extinct_species
```
```{r}
sp <-extinct_species$sci_name
ex_urls <-glue("{base}/species/narrative/{sp}?token={token}")|>
  URLencode()
```


```{r}

if(!file.exists("ex_narrative.rds")) {
  ex_narrative <- map(ex_urls, GET)
  map(ex_narrative,stop_for_status,.progress = TRUE)
  write_rds(ex_narrative, "ex_narrative.rds")
}

```

```{r}
ex_narrative <-read_rds("ex_narrative.rds")
```


```{r}
narrative_contents <- map(ex_narrative,content)
narrative_population <- map(narrative_contents,
                            \(content) map_chr(content$result[1],"population",.default = ""))
head(narrative_population,20)
#narrative_rationale <- map(narrative_contents,\(content)
                           #content$result[[1]]$rationale)

```



```{r}
last_seen <-narrative_population |>
  map_chr(str_extract,"\\d{4}") |>
  as.integer()
tibble(sp,last_seen)
```


## Extinctions Module

*Are we experiencing the sixth great extinction?*

What is the current pace of extinction? Is it accelerating? How does it compare to background extinction rates?

## Background

-   [Section Intro Video](https://youtu.be/QsH6ytm89GI)
-   [Ceballos et al (2015)](http://doi.org/10.1126/sciadv.1400253)

Our focal task will be to reproduce the result from Ceballos and colleagues showing the recent increase in extinction rates relative to the background rate:

![](https://espm-157.carlboettiger.info/img/extinctions.jpg)

## Computational Topics

-   Accessing data from a RESTful API
-   Error handling
-   JSON data format
-   Regular expressions
-   Working with missing values

## Additional references:

-   <http://www.hhmi.org/biointeractive/biodiversity-age-humans> (Video)
-   [Barnosky et al. (2011)](http://doi.org/10.1038/nature09678)
-   [Pimm et al (2014)](http://doi.org/10.1126/science.1246752)
-   [Sandom et al (2014)](http://dx.doi.org/10.1098/rspb.2013.3254)
